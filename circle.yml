machine:
  node:
    version: 4.2.5
  pre:
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
  services:
    - docker

dependencies:
  pre:
    - npm install
    - npm test
  override:
    - docker version
    - docker info
    - docker login -e="${DOCKER_EMAIL}" -u="${DOCKER_USER}" -p="${DOCKER_PASSWORD}" quay.io
    - docker run -v $(pwd):/data quay.io/turner/harbor-deploy:0.2.0 set_build_values -d "/data" -b "${CIRCLE_BRANCH}" -n "${CIRCLE_BUILD_NUM}" > buildprops;
    - source buildprops; docker build -t "quay.io/turner/${HARBOR_CONTAINER}:${HARBOR_VERSION}" .
    - source buildprops; docker push "quay.io/turner/${HARBOR_CONTAINER}:${HARBOR_VERSION}"
    - source buildprops; docker run quay.io/turner/harbor-deploy:0.2.0 deploy -s 'mss-shipit-api' -e 'dev' -p 'ec2' -c "${HARBOR_CONTAINER}" -v "${HARBOR_VERSION}" -r "${CUSTOMS_REGISTRY}" -t "${SHIPMENT_BUILD_TOKEN}" -a "${CUSTOMS_API}"

deployment:
  staging:
    branch: [master]
    commands:
      - source buildprops; docker tag "quay.io/turner/${HARBOR_CONTAINER}:${HARBOR_VERSION}" "quay.io/turner/${HARBOR_CONTAINER}:latest"
      - source buildprops; docker push "quay.io/turner/${HARBOR_CONTAINER}:latest"
